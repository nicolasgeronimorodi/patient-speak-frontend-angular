<form [formGroup]="form" class="speech-container border border-gray-300 dark:border-gray-700 rounded-lg p-5 shadow-sm max-w-2xl mx-auto bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100" *ngIf="isSupported; else notSupported">
    <!-- Estado -->
    <div class="flex justify-between mb-3">
        <span class="font-medium">Estado:</span>
        <span class="font-semibold" [ngClass]="{ 'text-red-500': isListening, 'text-gray-500': !isListening }">
      {{ isListening ? "Escuchando..." : "En espera" }}
    </span>
    </div>

    <!-- Texto reconocido -->
    <textarea formControlName="text" rows="6" placeholder="El texto reconocido aparecerá aquí..." class="w-full mb-1 border border-gray-700 rounded"></textarea>
    <div *ngIf="form.get('text')?.touched && form.get('text')?.hasError('required')" class="text-red-500 text-sm mb-4">
        El texto es obligatorio.
    </div>

    <!-- Categoría -->
    <p-dropdown class="my-1 w-full" [options]="tags" optionLabel="name" optionValue="id" formControlName="tag_id" placeholder="Seleccione una categoría"></p-dropdown>
    <div *ngIf="
      form.get('tag_id')?.touched && form.get('tag_id')?.hasError('required')
    " class="text-red-500 text-sm mb-4">
        La categoría es obligatoria.
    </div>



    <!-- DNI -->
    <div class="mb-3">
        <label for="dni" class="block font-medium mb-1">DNI del paciente *</label>
        <input type="text" id="dni" formControlName="dni" class="w-full px-3 py-2 rounded border dark:border-gray-600 border-gray-300 dark:bg-gray-800 bg-white" />
        <div *ngIf="form.get('dni')?.touched && form.get('dni')?.hasError('required')" class="text-red-500 text-sm">
            El DNI es obligatorio.
        </div>
        <div *ngIf="form.get('dni')?.touched && form.get('dni')?.hasError('invalidDni')" class="text-red-500 text-sm">
            El DNI debe tener entre 7 y 8 dígitos y no debe contener letras ni símbolos.
        </div>
    </div>

    <!-- Nombre -->
    <div class="mb-3">
        <label for="first_name" class="block font-medium mb-1">Nombre del paciente *</label>
        <input type="text" id="first_name" formControlName="first_name" class="w-full px-3 py-2 rounded border dark:border-gray-600 border-gray-300 dark:bg-gray-800 bg-white" />
        <div *ngIf="form.get('first_name')?.touched && form.get('first_name')?.hasError('required')" class="text-red-500 text-sm">
            El nombre es obligatorio.
        </div>
        <div *ngIf="form.get('first_name')?.touched && form.get('first_name')?.hasError('minlength')" class="text-red-500 text-sm">
            El nombre debe tener al menos 2 caracteres.
        </div>
        <div *ngIf="form.get('first_name')?.touched && form.get('first_name')?.hasError('maxlength')" class="text-red-500 text-sm">
            El nombre no puede tener más de 20 caracteres.
        </div>
    </div>

    <!-- Apellido -->
    <div class="mb-3">
        <label for="last_name" class="block font-medium mb-1">Apellido del paciente *</label>
        <input type="text" id="last_name" formControlName="last_name" class="w-full px-3 py-2 rounded border dark:border-gray-600 border-gray-300 dark:bg-gray-800 bg-white" />
        <div *ngIf="form.get('last_name')?.touched && form.get('last_name')?.hasError('required')" class="text-red-500 text-sm">
            El apellido es obligatorio.
        </div>
        <div *ngIf="form.get('last_name')?.touched && form.get('last_name')?.hasError('minlength')" class="text-red-500 text-sm">
            El apellido debe tener al menos 2 caracteres.
        </div>
        <div *ngIf="form.get('last_name')?.touched && form.get('last_name')?.hasError('maxlength')" class="text-red-500 text-sm">
            El apellido no puede tener más de 20 caracteres.
        </div>
    </div>

    <div class="flex items-start mt-4">
        <input type="checkbox" id="terms" formControlName="termsAccepted" class="mt-1 mr-2" />
        <label for="terms" class="text-sm">
      Acepto los
      <span
        class="underline text-blue-500 cursor-pointer"
        (click)="openTermsDialog()"
      >
        términos y condiciones </span
      >.
    </label>
    </div>
    <div *ngIf="
      form.get('termsAccepted')?.touched &&
      form.get('termsAccepted')?.hasError('required')
    " class="text-red-500 text-sm">
        Debe aceptar los términos y condiciones para continuar.
    </div>

    <!-- Botones -->
    <div class="flex flex-wrap gap-3 mt-3">
        <button *ngIf="!isListening" type="button" (click)="startListening()" class="flex-1 py-2 px-4 rounded-md bg-blue-500 hover:bg-blue-600 text-white font-medium">
      Iniciar grabación
    </button>

        <button pButton *ngIf="isListening" type="button" (click)="stopListening()" class="flex-1 py-2 px-4 rounded-md bg-red-500 hover:bg-red-600 text-white font-medium">
      Detener grabación
    </button>

        <button pButton type="button" (click)="resetText()" [disabled]="!form.get('text')?.value" class="flex-1 py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium" [ngClass]="{ 'opacity-50 cursor-not-allowed': !form.get('text')?.value }">
      Limpiar texto
    </button>

        <button pButton type="submit" (click)="save()" [disabled]="form?.invalid" class="flex-1 py-2 px-4 rounded-md bg-green-600 hover:bg-green-700 text-white font-medium">
      <span *ngIf="!isSaving">Guardar texto</span>
      <span *ngIf="isSaving">Guardando...</span>
    </button>
    </div>

    <!-- Error de guardado -->
    <div *ngIf="saveError" class="text-red-600 mt-4 text-sm">
        {{ saveError }}
    </div>
</form>

<!-- Soporte del navegador -->
<ng-template #notSupported>
    <div class="bg-red-100 text-red-800 dark:bg-red-950 dark:text-red-400 p-5 rounded-lg text-center font-medium">
        Tu navegador no soporta la API de reconocimiento de voz.
    </div>
</ng-template>