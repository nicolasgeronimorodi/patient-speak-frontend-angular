<form [formGroup]="form" class="speech-container border border-gray-300 dark:border-gray-700 rounded-lg p-5 shadow-sm max-w-2xl mx-auto bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100" *ngIf="isSupported; else notSupported">

    <!-- Estado -->
    <div class="flex justify-between mb-3">
        <span class="font-medium">Estado:</span>
        <span class="font-semibold" [ngClass]="{ 
          'text-red-500': isListening, 
          'text-gray-500': !isListening && !isProcessing,
          'text-blue-500': isProcessing 
        }">
          {{ isListening ? 'Escuchando...' : (isProcessing ? 'Procesando...' : 'En espera') }}
        </span>
    </div>

    <!-- Texto reconocido -->
    <div class="relative">
        <textarea 
            formControlName="text" 
            rows="6" 
            placeholder="El texto reconocido aparecerá aquí..." 
            class="w-full mb-1"
            [class.opacity-50]="isProcessing">
        </textarea>
        
        <!-- Loading overlay para Whisper -->
        <div *ngIf="isProcessing" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center rounded">
            <div class="text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-2 text-sm text-gray-600">Procesando audio...</p>
            </div>
        </div>
    </div>
    <div *ngIf="form.get('text')?.touched && form.get('text')?.hasError('required')" class="text-red-500 text-sm mb-4">
        El texto es obligatorio.
    </div>

    <!-- Categoría -->
    <p-dropdown class="my-1 w-full" [options]="tags" optionLabel="name" optionValue="id" formControlName="tag_id" placeholder="Seleccione una categoría"></p-dropdown>
    <div *ngIf="form.get('tag_id')?.touched && form.get('tag_id')?.hasError('required')" class="text-red-500 text-sm mb-4">
        La categoría es obligatoria.
    </div>

    <!-- Botones -->
    <div class="flex flex-wrap gap-3 mt-3">
        <button *ngIf="!isListening" type="button" (click)="startListening()" class="flex-1 py-2 px-4 rounded-md bg-blue-500 hover:bg-blue-600 text-white font-medium">
      Iniciar grabación
    </button>

        <button pButton *ngIf="isListening" type="button" (click)="stopListening()" class="flex-1 py-2 px-4 rounded-md bg-red-500 hover:bg-red-600 text-white font-medium">
      Detener grabación
    </button>

        <button pButton type="button" (click)="resetText()" [disabled]="!form.get('text')?.value" class="flex-1 py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium" [ngClass]="{ 'opacity-50 cursor-not-allowed': !form.get('text')?.value }">
      Limpiar texto
    </button>

        <button pButton type="submit" (click)="save()" [disabled]="form?.invalid" class="flex-1 py-2 px-4 rounded-md bg-green-600 hover:bg-green-700 text-white font-medium">
      <span *ngIf="!isSaving">Guardar texto</span>
      <span *ngIf="isSaving">Guardando...</span>
    </button>
    </div>

    <!-- Error de guardado -->
    <div *ngIf="saveError" class="text-red-600 mt-4 text-sm">
        {{ saveError }}
    </div>

</form>

<!-- Soporte del navegador -->
<ng-template #notSupported>
    <div class="bg-red-100 text-red-800 dark:bg-red-950 dark:text-red-400 p-5 rounded-lg text-center font-medium">
        Tu navegador no soporta la API de reconocimiento de voz.
    </div>
</ng-template>